<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pok√©Chain ‚Äî Tournament</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="collection-marketplace.css" />
  <link rel="stylesheet" href="tournament.css" />
  <link rel="stylesheet" href="transaction-modal.css" />
</head>

<body>
  <!-- === NAVBAR === -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent px-4 py-3">
    <a class="navbar-brand fs-3 fw-bold text-warning" href="index.html">Pok√©<span class="text-success">Chain</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav gap-3 align-items-center">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="marketplace.html">Marketplace</a></li>
        <li class="nav-item"><a class="nav-link" href="collection.html">Collection</a></li>
        <li class="nav-item"><a class="nav-link" href="transaction-history.html">Transactions</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-panel.html">Emergency Use Only</a></li>

        <li class="nav-item"><a class="nav-link active" href="tournament.html">Tournament</a></li>
            <!-- <li class="nav-item"><a class="nav-link" href="admin-panel.html">admin</a></li> -->

        <li class="nav-item">
          <div id="pctBalance" class="small-muted px-2">‚Äî</div>
        </li>
        <li class="nav-item"><button id="walletDisplay" class="btn btn-sm btn-outline-light">Connect</button></li>
      </ul>
    </div>
  </nav>

  <main class="container-fluid px-4">
    <!-- === COLLECTION HERO === -->
    <div class="collection-hero">
      <h1>Pok√©Chain Tournament Stadium</h1>
      <div class="small-muted">A round robin style Pok√©mon Tournament </div>
      <div id="connectionStatus" class="small-muted" style="color: #ff6b00; margin-top: 10px;">
        Connect wallet to view your Pok√©mon
      </div>
    </div>

    
    <!-- === TOURNAMENT SETTINGS PANEL === -->
<div class="tournament-settings-panel">
  
  <!-- Mode Selection: PvE Tournament or PvP Battle -->
  <div class="mode-selection-container" style="width: 100%; margin-bottom: 15px;">
    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
      <button id="pveBtn" class="mode-btn active" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--primary); border-radius: 10px; background: linear-gradient(180deg, rgba(0, 255, 157, 0.2), rgba(0, 255, 157, 0.1)); color: white; font-weight: 800; cursor: pointer; transition: all 0.3s;">
        üèÜ PvE TOURNAMENT
      </button>
      <a href="pvp-lobby.html" style="flex: 1; min-width: 200px; text-decoration: none;">
        <button class="mode-btn" style="width: 100%; padding: 12px; border: 2px solid rgba(255, 170, 0, 0.3); border-radius: 10px; background: rgba(255, 170, 0, 0.05); color: rgba(255, 255, 255, 0.8); font-weight: 800; cursor: pointer; transition: all 0.3s;">
          ‚öîÔ∏è TRY PvP BETA
        </button>
      </a>
    </div>
  </div>

  <!-- Selected Pokemon Display -->
  <div id="selectedPokemonDisplay" class="selected-pokemon-display" style="display: none;">
    <img id="selectedPokemonImage" src="" alt="">
    <div class="selected-pokemon-info">
      <div id="selectedPokemonName" class="selected-pokemon-name"></div>
      <div id="selectedPokemonId" class="selected-pokemon-id"></div>
    </div>
  </div>

  PvE Tournament Options (default)
  <div id="pveOptions" class="tournament-options">
    <div class="tournament-option">
      <label for="opponentCount">Opponents</label>
      <select id="opponentCount" class="tournament-select">
        <option value="4">5 (Quick)</option>
        <option value="7" selected>8 (Standard)</option>
        <option value="9">10 (Epic)</option>
      </select>
    </div>

    <div class="tournament-option">
      <label for="difficulty">Difficulty</label>
      <select id="difficulty" class="tournament-select">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="insane">Insane</option>
      </select>
    </div>
  </div>

  <!-- PvP Info (hidden by default) -->
  <div id="pvpInfo" class="tournament-options" style="display: none;">
    <div style="padding: 15px; background: rgba(255, 170, 0, 0.1); border: 2px solid var(--warning); border-radius: 10px; text-align: center;">
      <div style="font-size: 1.2rem; font-weight: 800; color: var(--warning); margin-bottom: 10px;">
        ‚öîÔ∏è 1v1 PvP Battle
      </div>
      <div style="font-size: 0.9rem; margin-bottom: 8px;">
        üí∞ <strong>Stake:</strong> 250 PKCN per player
      </div>
      <div style="font-size: 0.9rem; margin-bottom: 8px;">
        üèÜ <strong>Winner takes:</strong> 500 PKCN
      </div>
      <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.8);">
        Real-time matchmaking with other players
      </div>
    </div>
  </div>

  <button id="startTournamentBtn" class="btn-start-tournament" disabled>
    START TOURNAMENT
  </button> 

  <!-- Queue Status (for PvP) -->
  <div id="queueStatus" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0, 255, 157, 0.1); border: 2px solid var(--primary); border-radius: 10px; text-align: center;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
      <div class="spinner-border spinner-border-sm text-success"></div>
      <span id="queueStatusText" style="font-weight: 700; color: var(--primary);">Searching for opponent...</span>
    </div>
    <button id="cancelQueueBtn" style="margin-top: 10px; padding: 8px 20px; border: none; border-radius: 8px; background: var(--danger); color: white; font-weight: 700; cursor: pointer;">
      CANCEL
    </button>
  </div>
</div>

      <!-- Tournament Options
      <div class="tournament-options">
        <div class="tournament-option">
          <label for="opponentCount">Opponents</label>
          <select id="opponentCount" class="tournament-select">
            <option value="4">5(Quick)</option>
            <option value="7" selected>8(Standard)</option>
            <option value="9">10(Epic)</option>
          </select>
        </div>

        <div class="tournament-option">
          <label for="difficulty">Difficulty</label>
          <select id="difficulty" class="tournament-select">
            <option value="easy">Easy</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Hard</option>
            <option value="insane">Insane</option>
          </select>
        </div>
      </div> -->

      <!-- Start Button
      <button id="startTournamentBtn" class="btn-start-tournament" disabled>
        START TOURNAMENT
      </button>
    </div> -->

    <p id="startError" class="tournament-error" style="display: none;">
      Please select a Pok√©mon first!
    </p>
    <div id="startError"
      style="display: none; margin-top: 15px; padding: 10px; background: rgba(255, 0, 0, 0.2); border: 1px solid #ff0000; border-radius: 5px; color: #ff6b00;">
      <!-- Error message will appear here -->
    </div>
    <button id="clearTournamentBtn" style="display: none; margin-top: 10px;" class="btn btn-warning">
      üö® Force Clear Active Tournament
    </button>

    <!-- === POKEMON SELECTION GRID === -->
    <div class="tournament-section-title">
      <h2>Choose Your Pok√©mon</h2>
      <div class="small-muted">Click a Pok√©mon to select it for battle</div>
    </div>

    <div id="pokemonSelectionGrid" class="market-grid">
      <!-- Loading state -->
      <div id="tournamentLoading" class="loader" style="grid-column: 1/-1;">
        <div class="spinner-border text-success" role="status"></div>
        <p style="margin-top: 15px; color: rgba(255,255,255,0.6);">Loading your collection...</p>
      </div>

      <!-- No Pokemon Message -->
      <div id="noPokemonMessage" class="empty-collection" style="display: none; grid-column: 1/-1;">
        <h3>You don't own any Pok√©mon yet.</h3>
        <p>Visit the marketplace to buy your first battle companion!</p>
        <a href="marketplace.html" class="btn-marketplace">Buy Pok√©mon</a>
      </div>
    </div>
  </main>

  <!-- Tournament Confirmation Modal -->
  <div class="modal fade" id="tournamentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"
        style="background: linear-gradient(135deg, rgba(20,20,30,0.95), rgba(10,10,20,0.9)); border: 2px solid var(--primary); border-radius: 20px;">
        <div class="modal-header" style="border-bottom: 1px solid rgba(0,255,157,0.3);">
          <h5 class="modal-title" style="color: var(--primary); font-weight: 800;">Confirm Tournament Entry</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div
            style="background: rgba(0,255,157,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,255,157,0.2);">
            <h6 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;"> Entry Details</h6>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Entry Fee:</span>
              <span style="color: var(--warning); font-weight: 800;" id="modalEntryFee">50 PKCN</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Difficulty:</span>
              <span id="modalDifficulty">-</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Opponents:</span>
              <span id="modalOpponents">-</span>
            </div>
          </div>

          <div
            style="background: rgba(0,196,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,196,255,0.2);">
            <h6 style="color: var(--info); margin-bottom: 15px; font-weight: 700;"> Estimated Rewards</h6>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>Min Reward:</span>
              <span style="color: var(--info);" id="modalMinReward">-</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Max Reward:</span>
              <span style="color: var(--success); font-weight: 800;" id="modalMaxReward">-</span>
            </div>
          </div>

          <div
            style="background: rgba(255,217,61,0.05); border-radius: 12px; padding: 15px; border: 1px solid rgba(255,217,61,0.2);">
            <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
              üí° <strong>Tip:</strong> Win all matches for a Perfect Bonus! You must approve the entry fee before
              starting.
            </p>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmTournamentBtn"
            style="background: linear-gradient(180deg, var(--primary), #00c474); border: none; font-weight: 800;">
            <span id="confirmBtnText">Approve & Start</span>
            <span class="spinner-border spinner-border-sm" id="confirmBtnSpinner" style="display: none;"></span>
          </button>
        </div>

        <!-- === PROFILE MODAL (Previously profile.html) === -->
        <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-fullscreen-md-down">
            <div class="modal-content profile-modal-content">
              <!-- Modal Header -->
              <div class="modal-header"
                style="background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%); border-bottom: 2px solid var(--primary);">
                <h5 class="modal-title" id="profileModalLabel" style="color: var(--primary); font-weight: 800;">
                  <i class="bi bi-person-badge"></i> Trainer Profile & Rewards
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>

              <!-- Modal Body -->
              <div class="modal-body"
                style="background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%); color: white; padding: 0;">
                <!-- Profile Header -->
                <div class="profile-header"
                  style="text-align: center; padding: 20px 0; border-bottom: 2px solid var(--primary);">
                  <h1 style="font-size: 1.8em; color: var(--primary); text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">
                    Pokemon Trainer Profile
                  </h1>
                  <div class="wallet-address" id="profileWalletAddress"
                    style="color: var(--secondary); font-family: monospace; margin-top: 5px;">
                    Not Connected
                  </div>
                  <div class="mt-2">
                    <span id="profileNetworkInfo" class="badge bg-secondary"></span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshProfileData()">
                      <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                  </div>
                </div>

                <!-- Connection Status -->
                <div id="profileConnectionStatus" class="error-box"
                  style="display: none; margin: 15px; background: rgba(255,0,0,0.1); border: 1px solid #ff4444; border-radius: 8px; padding: 10px; color: #ff8888;">
                  <h6><i class="bi bi-exclamation-triangle-fill"></i> Connection Issues</h6>
                  <p id="profileConnectionMessage">Checking connection...</p>
                  <button class="btn btn-sm btn-primary mt-1" onclick="connectWallet()">
                    <i class="bi bi-plug"></i> Connect Wallet
                  </button>
                </div>

                <!-- Main Content -->
                <div class="container" style="padding: 20px; max-width: 1000px; margin: 0 auto;">
                  <!-- PKCN Balance & Authorization -->
                  <div class="balance-card"
                    style="background: rgba(0,0,0,0.4); border: 2px solid var(--primary); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center;">
                    <h3 style="color: var(--primary); margin-bottom: 15px;">PKCN Balance</h3>
                    <div class="balance-amount" id="profilePkcnBalance"
                      style="font-size: 2em; color: var(--primary); font-weight: bold;">
                      0
                    </div>

                    <!-- Authorization Section -->
                    <div class="authorization-section"
                      style="background: rgba(255,170,0,0.1); border: 1px solid var(--secondary); border-radius: 8px; padding: 15px; margin-top: 20px;">
                      <h6 style="color: var(--secondary);"><i class="bi bi-shield-check"></i> PKCN Authorization</h6>
                      <p style="font-size: 0.9em; color: #aaa;">Tournament needs permission to transfer PKCN rewards</p>

                      <div class="mb-2">
                        <strong>Current Allowance:</strong>
                        <span id="profileCurrentAllowance" class="text-warning">Checking...</span> PKCN
                      </div>

                      <div class="d-flex flex-wrap gap-2 justify-content-center mt-3">
                        <button class="btn btn-sm btn-warning" onclick="checkProfileAllowance()">
                          <i class="bi bi-arrow-repeat"></i> Check
                        </button>
                        <button class="btn btn-sm btn-success" onclick="approveProfilePKCN()" id="profileApproveBtn">
                          <i class="bi bi-check-circle"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="revokeProfilePKCN()" id="profileRevokeBtn"
                          style="display: none;">
                          <i class="bi bi-x-circle"></i> Revoke
                        </button>
                      </div>

                      <div class="mt-2">
                        <small class="text-muted">
                          <i class="bi bi-info-circle"></i>
                          Tournament Contract: <span id="profileTournamentContract">Loading...</span>
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- Active Tournament Warning -->
                  <div id="profileActiveTournamentAlert" class="active-tournament-alert"
                    style="display: none; background: rgba(255,170,0,0.2); border: 1px solid var(--secondary); border-radius: 8px; padding: 15px; margin: 15px 0; text-align: center;">
                    <h6 style="color: var(--secondary);"><i class="bi bi-exclamation-triangle-fill"></i> Active
                      Tournament!</h6>
                    <p style="font-size: 0.9em;">You have an active tournament that needs to be completed.</p>
                    <div class="mt-2">
                      <span id="profileActiveTournamentId" class="badge bg-warning text-dark me-2"></span>
                      <button id="profileClaimActiveTournamentBtn" class="btn btn-sm btn-success">
                        <i class="bi bi-cash"></i> Claim Reward
                      </button>
                    </div>
                  </div>

                  <!-- Unclaimed Rewards Section -->
                  <div class="section-card" id="profileClaimSection"
                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,170,0,0.3); border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <h5 style="color: var(--secondary); text-align: center; margin-bottom: 15px;">
                      <i class="bi bi-gift"></i> Unclaimed Tournament Rewards
                    </h5>
                    <div id="profileUnclaimedList" style="min-height: 100px;">
                      <div class="no-data" style="text-align: center; padding: 20px; color: #666;">
                        Connect wallet to see unclaimed rewards
                      </div>
                    </div>
                    <div class="text-center mt-3">
                      <strong>Total Unclaimed:</strong>
                      <span id="profileTotalUnclaimed"
                        style="color: var(--primary); font-weight: bold; margin-left: 5px;">0 PKCN</span>
                    </div>
                    <button id="profileClaimAllBtn" class="btn btn-warning mt-3" style="display: none; width: 100%;">
                      <i class="bi bi-wallet2"></i> Claim All Rewards
                    </button>
                  </div>

                  <!-- Quick Actions -->
                  <div class="quick-actions"
                    style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <h6 style="color: var(--primary); margin-bottom: 15px;">Quick Actions</h6>
                    <div class="d-flex flex-wrap gap-2">
                      <button class="btn btn-sm btn-info" onclick="debugProfileAllowance()">
                        <i class="bi bi-bug"></i> Debug Allowance
                      </button>
                      <button class="btn btn-sm btn-info" onclick="getProfileActiveTournamentInfo()">
                        <i class="bi bi-search"></i> Check Active
                      </button>
                      <button class="btn btn-sm btn-success" onclick="getProfileUnclaimedRewardsInfo()">
                        <i class="bi bi-gift"></i> Check Rewards
                      </button>
                      <button class="btn btn-sm btn-secondary" onclick="testAllProfileFunctions()">
                        <i class="bi bi-gear"></i> Test Functions
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Profile Toast Notification -->
        <div class="toast-notification" id="profileToastNotification"
          style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.9); border: 2px solid var(--primary); border-radius: 10px; padding: 10px 15px; color: var(--primary); z-index: 1100; display: none; max-width: 300px;">
          <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span id="profileToastMessage">Claim successful!</span>
          </div>
        </div>

        <!-- Profile Loading Spinner -->
        <div id="profileLoadingSpinner" class="text-center"
          style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1100; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;">
          <div class="spinner-border text-success" style="width: 2rem; height: 2rem;" role="status"></div>
          <p class="mt-2" id="profileLoadingMessage" style="color: white;">Processing...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add BEFORE your other scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./config.js"></script>
  <script src="./auth.js"></script>
  <script src="./wallet.js"></script>
  <script src="navbar-auth.js"></script>
  <script src="transaction-modal.js"></script>
  <script src="collection.js"></script>
  <script src="pvp.js"></script>
  <script src="tournament.js"></script>

  <script>
    // Route protection - check authentication
    window.addEventListener('DOMContentLoaded', async () => {
      const authenticated = await window.auth.requireAuth();
      if (!authenticated) {
        return; // Already redirected to login
      }
    });
  </script>
  
  <script>
// ===================================================================
// PVP MATCHMAKING LOGIC
// ===================================================================

let currentMode = 'pve'; // 'pve' or 'pvp'
let inQueue = false;
let queueSubscription = null;

// Mode toggle handlers
document.getElementById('pveModeBtn').addEventListener('click', () => switchMode('pve'));
document.getElementById('pvpModeBtn').addEventListener('click', () => switchMode('pvp'));

function switchMode(mode) {
  currentMode = mode;
  
  // Update button styles
  const pveBtn = document.getElementById('pveModeBtn');
  const pvpBtn = document.getElementById('pvpModeBtn');

  
  if (mode === 'pve') {
    pveBtn.classList.add('active');
    pvpBtn.classList.remove('active');
    pveBtn.style.background = 'linear-gradient(180deg, rgba(0, 255, 157, 0.2), rgba(0, 255, 157, 0.1))';
    pveBtn.style.borderColor = 'var(--primary)';
    pveBtn.style.color = 'white';
    pvpBtn.style.background = 'rgba(255, 255, 255, 0.05)';
    pvpBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
    pvpBtn.style.color = 'rgba(255, 255, 255, 0.7)';
    
    // Show PvE UI, hide PvP UI
    document.getElementById('pveOptions').style.display = 'flex';
    document.getElementById('pvpInfo').style.display = 'none';
    
    // Show tournament options dropdowns
    const opponentOption = document.getElementById('opponentCount').closest('.tournament-option');
    const difficultyOption = document.getElementById('difficulty').closest('.tournament-option');
    if (opponentOption) opponentOption.style.display = 'block';
    if (difficultyOption) difficultyOption.style.display = 'block';
    
    elements.startBtn.textContent = 'START TOURNAMENT';
    
  } else {
    pvpBtn.classList.add('active');
    pveBtn.classList.remove('active');
    pvpBtn.style.background = 'linear-gradient(180deg, rgba(255, 170, 0, 0.2), rgba(255, 170, 0, 0.1))';
    pvpBtn.style.borderColor = 'var(--warning)';
    pvpBtn.style.color = 'white';
    pveBtn.style.background = 'rgba(255, 255, 255, 0.05)';
    pveBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
    pveBtn.style.color = 'rgba(255, 255, 255, 0.7)';
    
    // Hide PvE UI, show PvP UI
    document.getElementById('pveOptions').style.display = 'none';
    document.getElementById('pvpInfo').style.display = 'block';
    
    // HIDE tournament options dropdowns in PvP mode
    const opponentOption = document.getElementById('opponentCount').closest('.tournament-option');
    const difficultyOption = document.getElementById('difficulty').closest('.tournament-option');
    if (opponentOption) opponentOption.style.display = 'none';
    if (difficultyOption) difficultyOption.style.display = 'none';
    
    elements.startBtn.textContent = 'FIND MATCH';
  }
}

// Override start button click
document.getElementById('startTournamentBtn').addEventListener('click', async () => {
  console.log('üéØ Start button clicked. Mode:', currentMode);
  
  // Validate Pok√©mon selected
  if (!tournamentState.selectedPokemon) {
    elements.startError.style.display = 'block';
    elements.startError.textContent = '‚ö†Ô∏è Please select a Pok√©mon first!';
    return;
  }
  
  // Route based on mode
  if (currentMode === 'pve') {
    console.log('üèÜ Starting PvE Tournament');
    showTournamentModal(); // Original PvE flow
  } else if (currentMode === 'pvp') {
    console.log('‚öîÔ∏è Starting PvP Matchmaking');
    await startPvPMatchmaking(); // PvP flow
  } else {
    console.error('‚ùå Invalid mode:', currentMode);
  }
})

// ===================================================================
// PVP MATCHMAKING
// ===================================================================

async function startPvPMatchmaking() {
  if (!tournamentState.selectedPokemon) {
    elements.startError.style.display = 'block';
    elements.startError.textContent = '‚ö†Ô∏è Please select a Pok√©mon first!';
    return;
  }

  if (!window.supabaseClient) {
    alert('‚ùå Supabase not initialized. Check your config.js');
    return;
  }

  try {
    elements.startBtn.disabled = true;
    
    // Check wallet balance
    const provider = await safeGetProvider();
    const signer = await provider.getSigner();
    const account = await signer.getAddress();
    
    const pkcnContract = new ethers.Contract(
      window.CONTRACTS.PKCN,
      window.ABIS.PKCN,
      signer
    );
    
    const balance = await pkcnContract.balanceOf(account);
    if (balance < 250) {
      throw new Error('Insufficient PKCN balance. Need 250 PKCN.');
    }
    
    // Check and approve PKCN
    const allowance = await pkcnContract.allowance(account, window.CONTRACTS.TOURNAMENT);
    if (allowance < 250) {
      console.log('Approving 250 PKCN...');
      const approveTx = await pkcnContract.approve(window.CONTRACTS.TOURNAMENT, 250);
      await approveTx.wait();
      console.log('‚úÖ Approved');
    }
    
    // Join matchmaking queue
    console.log('Joining queue...');
    
    const response = await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/matchmaking`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
      },
      body: JSON.stringify({
        action: 'join_queue',
        player_address: account,
        pokemon_data: tournamentState.selectedPokemon,
        stake_amount: 250
      })
    });
    
    const result = await response.json();
    console.log('Queue result:', result);
    
    if (result.error) {
      throw new Error(result.error);
    }
    
    if (result.match) {
      // Matched immediately!
      console.log('‚úÖ Match found immediately!');
      await onMatchFound(result.match);
    } else {
      // Waiting for opponent
      console.log('‚è≥ Waiting for opponent...');
      showQueueStatus();
      subscribeToMatchUpdates(account);
    }
    
  } catch (error) {
    console.error('Matchmaking error:', error);
    elements.startError.style.display = 'block';
    elements.startError.textContent = `‚ùå ${error.message}`;
    elements.startBtn.disabled = false;
  }
}

function showQueueStatus() {
  inQueue = true;
  document.getElementById('queueStatus').style.display = 'block';
  elements.startBtn.style.display = 'none';
}

function hideQueueStatus() {
  inQueue = false;
  document.getElementById('queueStatus').style.display = 'none';
  elements.startBtn.style.display = 'block';
  elements.startBtn.disabled = false;
}

// Subscribe to queue updates
function subscribeToMatchUpdates(playerAddress) {
  queueSubscription = window.supabaseClient
    .channel('matchmaking_updates')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'matchmaking_queue',
      filter: `player_address=eq.${playerAddress}`
    }, async (payload) => {
      console.log('Queue update:', payload);
      
      if (payload.new.status === 'matched' && payload.new.match_id) {
        // Match found!
        queueSubscription.unsubscribe();
        
        // Fetch match data
        const { data: match } = await window.supabaseClient
          .from('pvp_matches')
          .select('*')
          .eq('id', payload.new.match_id)
          .single();
        
        if (match) {
          await onMatchFound(match);
        }
      }
    })
    .subscribe();
}

// Cancel queue
document.getElementById('cancelQueueBtn').addEventListener('click', async () => {
  if (!inQueue) return;
  
  try {
    const account = window.wallet.getAccount();
    
    await fetch(`${window.SUPABASE_CONFIG.url}/functions/v1/matchmaking`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${window.SUPABASE_CONFIG.anonKey}`
      },
      body: JSON.stringify({
        action: 'leave_queue',
        player_address: account
      })
    });
    
    if (queueSubscription) {
      queueSubscription.unsubscribe();
    }
    
    hideQueueStatus();
    console.log('Left queue');
    
  } catch (error) {
    console.error('Error leaving queue:', error);
  }
});

// ===================================================================
// MATCH FOUND
// ===================================================================

async function onMatchFound(matchData) {
  console.log('üéÆ Match found!', matchData);
  hideQueueStatus();
  
  try {
    // Create match on-chain
    const provider = await safeGetProvider();
    const signer = await provider.getSigner();
    const account = await signer.getAddress();
    
    const tournamentContract = new ethers.Contract(
      window.CONTRACTS.TOURNAMENT,
      window.ABIS.TOURNAMENT,
      signer
    );
    
    // Only first player creates the match
    const isPlayer1 = matchData.player1_address === account;
    
    if (isPlayer1) {
      console.log('Creating match on-chain...');
      
      const tx = await tournamentContract.createPvPMatch(
        matchData.match_id,
        matchData.player1_address,
        matchData.player2_address,
        matchData.player1_pokemon.tokenId,
        matchData.player2_pokemon.tokenId
      );
      
      await tx.wait();
      console.log('‚úÖ Match created on-chain');
    } else {
      console.log('Waiting for Player 1 to create match on-chain...');
      // Wait a bit for Player 1 to create match
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
    
    // Navigate to battle page
    const params = new URLSearchParams({
      mode: 'pvp',
      matchId: matchData.match_id,
      matchData: encodeURIComponent(JSON.stringify(matchData))
    });
    
    window.location.href = `battle.html?${params.toString()}`;
    
  } catch (error) {
    console.error('Failed to create match:', error);
    alert(`‚ùå Match creation failed: ${error.message}`);
    hideQueueStatus();
  }
}

console.log('‚úÖ PvP matchmaking loaded');
</script>
</body>


</html>