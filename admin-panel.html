<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Admin Panel - FORCE COMPLETE</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background: #1a1a2e; color: #00ff9d; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: rgba(0,0,0,0.5); padding: 20px; margin: 15px 0; border: 1px solid #00ff9d; border-radius: 8px; }
        .btn { background: #00ff9d; color: #000; border: none; padding: 12px 24px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .btn-danger { background: #ff4444; color: white; }
        .btn-warning { background: #ffaa00; color: black; }
        .btn-success { background: #00c853; color: white; }
        input { padding: 10px; width: 100%; margin: 5px 0; background: #000; color: #00ff9d; border: 1px solid #00ff9d; }
        pre { background: #000; padding: 15px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; border-left: 3px solid; }
        .success { background: rgba(0, 255, 157, 0.1); border-color: #00ff9d; }
        .error { background: rgba(255, 68, 68, 0.1); border-color: #ff4444; color: #ff4444; }
        .info { background: rgba(255, 170, 0, 0.1); border-color: #ffaa00; color: #ffaa00; }
        h1, h3 { color: #00ff9d; text-shadow: 0 0 10px rgba(0, 255, 157, 0.5); }
        .tournament-list { max-height: 400px; overflow-y: auto; }
        .tournament-item { padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border-left: 3px solid #00ff9d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Tournament Admin Panel - FORCE COMPLETE</h1>
        
        <!-- ===== CONFIGURATION ===== -->
        <div class="card">
            <h3>‚öôÔ∏è Contract Configuration</h3>
            <p style="color: #ffaa00;">Enter your deployed contract addresses (or load from storage)</p>
            <input type="text" id="pkcnAddress" placeholder="PKCN Token Address (0x...)">
            <input type="text" id="tournamentAddress" placeholder="Tournament Contract Address (0x...)">
            <button class="btn" onclick="saveConfig()">Save Config</button>
            <button class="btn" onclick="loadConfig()">Load Config</button>
            <div id="configStatus" class="status info">Enter addresses and click Save</div>
        </div>

        <!-- ===== VIEW EXISTING TOURNAMENTS ===== -->
        <div class="card">
            <h3>üëÅÔ∏è View Your Existing Tournaments</h3>
            <input type="text" id="playerAddress" placeholder="Player Address (leave empty for current wallet)">
            <button class="btn" onclick="viewExistingTournaments()">
                üîç View My Tournaments
            </button>
            <div id="existingTournaments" class="tournament-list"></div>
        </div>

        <!-- ===== FORCE COMPLETE TOURNAMENT ===== -->
        <div class="card">
            <h3>üéØ Force Complete Tournament (Claim Rewards)</h3>
            <p style="color: #ffaa00;">This will mark tournament as COMPLETE so you can claim rewards in Profile</p>
            
            <input type="text" id="tournamentId" placeholder="Enter Tournament ID (e.g., tour_9807289_1765337456573_qxm05vq30fe_0e610b70)">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="number" id="winsInput" placeholder="Number of Wins" min="0" max="20">
                <select id="perfectSelect" style="background: #000; color: #00ff9d; border: 1px solid #00ff9d; padding: 10px;">
                    <option value="false">Not Perfect Run</option>
                    <option value="true">Perfect Run (All Wins)</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="forceCompleteTournament()">
                üèÅ Force Complete Tournament
            </button>
            
            <button class="btn" onclick="checkTournamentState()">
                üîç Check Tournament State
            </button>
            
            <div id="completeStatus" class="status info">Not executed yet</div>
        </div>

        <!-- ===== CLAIM REWARDS ===== -->
        <div class="card">
            <h3>üí∞ Claim Rewards from Profile</h3>
            <p>After force-completing, go to <strong>Profile page</strong> to claim rewards</p>
            
            <button class="btn btn-warning" onclick="checkUnclaimedRewards()">
                üîç Check Unclaimed Rewards
            </button>
            
            <button class="btn" onclick="window.location.href='profile.html'">
                üì± Go to Profile Page
            </button>
            
            <div id="claimStatus" class="status info">Not checked yet</div>
        </div>

        <!-- ===== EMERGENCY ===== -->
        <div class="card">
            <h3>‚ö° Emergency Functions</h3>
            
            <button class="btn btn-danger" onclick="clearLocalStorage()">
                üóëÔ∏è Clear All LocalStorage
            </button>
            
            <div id="emergencyStatus" class="status info">No actions taken</div>
        </div>
    </div>

    <script>
        // ==================== CORRECT ABI (Matches Your Contract) ====================
        const TOURNAMENT_ABI = [
            // Read tournament data
            "function tournaments(string tournamentId) view returns (address player, uint256 tokenId, string difficulty, uint256 opponentCount, uint256 wins, bool isComplete, bool rewardClaimed, uint256 entryFee, uint256 finalReward, uint256 startBlock)",
            
            // Player mapping
            "function playerTournaments(address player) view returns (string memory)",
            
            // Tournament actions
            "function completeTournament(string tournamentId, uint256 wins, bool isPerfect) external",
            "function claimReward(string tournamentId) external",
            
            // Constants
            "function TOURNAMENT_DURATION_BLOCKS() view returns (uint256)",
            
            // Admin
            "function owner() view returns (address)",
            
            // Unclaimed rewards
            "function getUnclaimedRewards(address player) view returns (string[] memory tournamentIds, uint256[] memory rewards)"
        ];

        const PKCN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function owner() view returns (address)"
        ];

        // ==================== CONFIG & STATE ====================
        let CONFIG = { PKCN: '', TOURNAMENT: '' };
        let provider, signer, tournamentContract, pkcnContract, currentAddress;

        // ==================== UTILITY FUNCTIONS ====================
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        function saveConfig() {
            CONFIG.PKCN = document.getElementById('pkcnAddress').value.trim();
            CONFIG.TOURNAMENT = document.getElementById('tournamentAddress').value.trim();
            localStorage.setItem('tournamentAdminConfig', JSON.stringify(CONFIG));
            showStatus('configStatus', '‚úÖ Configuration saved!', 'success');
            console.log('Config saved:', CONFIG);
        }

        function loadConfig() {
            const saved = localStorage.getItem('tournamentAdminConfig');
            if (saved) {
                CONFIG = JSON.parse(saved);
                document.getElementById('pkcnAddress').value = CONFIG.PKCN || '';
                document.getElementById('tournamentAddress').value = CONFIG.TOURNAMENT || '';
                showStatus('configStatus', '‚úÖ Configuration loaded!', 'success');
            } else {
                showStatus('configStatus', '‚ö†Ô∏è No saved config found', 'info');
            }
        }

        async function init() {
            if (!window.ethereum) {
                showStatus('completeStatus', '‚ùå MetaMask not detected', 'error');
                return false;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    showStatus('completeStatus', '‚ùå No wallet connected', 'error');
                    return false;
                }

                if (!CONFIG.TOURNAMENT) {
                    loadConfig();
                    if (!CONFIG.TOURNAMENT) {
                        showStatus('completeStatus', '‚ùå Please configure contract addresses', 'error');
                        return false;
                    }
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                currentAddress = await signer.getAddress();

                tournamentContract = new ethers.Contract(CONFIG.TOURNAMENT, TOURNAMENT_ABI, signer);
                pkcnContract = new ethers.Contract(CONFIG.PKCN, PKCN_ABI, signer);

                console.log('‚úÖ Initialized:', currentAddress);
                return true;
            } catch (error) {
                showStatus('completeStatus', `‚ùå Init failed: ${error.message}`, 'error');
                return false;
            }
        }

        // ==================== VIEW EXISTING TOURNAMENTS ====================
        async function viewExistingTournaments() {
            if (!await init()) return;

            const playerAddress = document.getElementById('playerAddress').value.trim() || currentAddress;
            const display = document.getElementById('existingTournaments');

            try {
                showStatus('existingTournaments', '‚è≥ Loading tournaments...', 'info');
                
                // Get active tournament
                const activeTournamentId = await tournamentContract.playerTournaments(playerAddress);
                
                // Get unclaimed rewards (completed but not claimed)
                const [completedIds, completedRewards] = await tournamentContract.getUnclaimedRewards(playerAddress);
                
                let html = '';
                
                // Show ACTIVE tournament
                if (activeTournamentId && activeTournamentId !== '') {
                    try {
                        const data = await tournamentContract.tournaments(activeTournamentId);
                        const currentBlock = await provider.getBlockNumber();
                        const duration = await tournamentContract.TOURNAMENT_DURATION_BLOCKS();
                        const startBlock = Number(data.startBlock);
                        const blocksPassed = currentBlock - startBlock;
                        const isExpired = blocksPassed > Number(duration);

                        html += `<div class="tournament-item" style="border-left-color: #00ff9d;">
                            <strong>üéØ ACTIVE TOURNAMENT</strong><br>
                            <strong>ID:</strong> ${activeTournamentId}<br>
                            <strong>Difficulty:</strong> ${data.difficulty}<br>
                            <strong>Wins:</strong> ${data.wins.toString()}/${data.opponentCount.toString()}<br>
                            <strong>Status:</strong> ${data.isComplete ? '‚úÖ Complete' : '‚è≥ Active'}<br>
                            <strong>Expired:</strong> ${isExpired ? '‚úÖ Yes' : '‚ùå No'} (${blocksPassed}/${Number(duration)} blocks)<br>
                            <strong>Reward Claimed:</strong> ${data.rewardClaimed ? '‚úÖ Yes' : '‚ùå No'}<br>
                        </div>`;
                    } catch (e) {
                        html += `<div class="tournament-item" style="border-left-color: #ffaa00;">
                            <strong>‚ö†Ô∏è Active Tournament (Error loading details)</strong><br>
                            <strong>ID:</strong> ${activeTournamentId}<br>
                        </div>`;
                    }
                } else {
                    html += `<div class="tournament-item" style="border-left-color: #666;">
                        <strong>‚ùå No Active Tournament</strong><br>
                        No tournament currently in progress.
                    </div>`;
                }

                // Show COMPLETED but unclaimed tournaments
                if (completedIds.length > 0) {
                    html += `<br><strong>üí∞ COMPLETED TOURNAMENTS (Unclaimed Rewards)</strong><br>`;
                    for (let i = 0; i < completedIds.length; i++) {
                        try {
                            const data = await tournamentContract.tournaments(completedIds[i]);
                            html += `<div class="tournament-item" style="border-left-color: #ffaa00;">
                                <strong>ID:</strong> ${completedIds[i].substring(0, 30)}...<br>
                                <strong>Wins:</strong> ${data.wins.toString()}/${data.opponentCount.toString()}<br>
                                <strong>Reward:</strong> ${completedRewards[i].toString()} PKCN<br>
                                <strong>Status:</strong> üéÅ Ready to claim in Profile
                            </div>`;
                        } catch (e) {
                            html += `<div class="tournament-item" style="border-left-color: #ff4444;">
                                <strong>ID:</strong> ${completedIds[i].substring(0, 30)}...<br>
                                <strong>Status:</strong> ‚ö†Ô∏è Error loading details
                            </div>`;
                        }
                    }
                }

                // Show message if no tournaments at all
                if (!activeTournamentId && completedIds.length === 0) {
                    html = `<div class="tournament-item">
                        <strong>üì≠ No tournaments found</strong><br>
                        This address has no active or completed tournaments.
                    </div>`;
                }

                showStatus('existingTournaments', html, 'info');

            } catch (error) {
                showStatus('existingTournaments', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ==================== FORCE COMPLETE FUNCTION ====================
        async function forceCompleteTournament() {
            if (!await init()) return;

            const tournamentId = document.getElementById('tournamentId').value.trim();
            const wins = parseInt(document.getElementById('winsInput').value);
            const isPerfect = document.getElementById('perfectSelect').value === 'true';

            if (!tournamentId) {
                showStatus('completeStatus', '‚ö†Ô∏è Enter tournament ID', 'error');
                return;
            }

            if (isNaN(wins) || wins < 0) {
                showStatus('completeStatus', '‚ö†Ô∏è Enter valid number of wins', 'error');
                return;
            }

            try {
                showStatus('completeStatus', '‚è≥ Checking tournament...', 'info');

                // Check if tournament exists
                const data = await tournamentContract.tournaments(tournamentId);
                
                if (data.player === ethers.ZeroAddress && data.wins === 0n) {
                    showStatus('completeStatus', `
                        ‚ùå Tournament does NOT exist on-chain<br>
                        <strong>ID:</strong> ${tournamentId}<br>
                        <br><span style="color:#ffaa00">üí° This tournament is only in localStorage. Clear it to start fresh.</span>
                    `, 'error');
                    return;
                }

                if (data.isComplete) {
                    showStatus('completeStatus', '‚ùå Tournament already completed', 'error');
                    return;
                }

                if (data.rewardClaimed) {
                    showStatus('completeStatus', '‚ùå Reward already claimed', 'error');
                    return;
                }

                // Verify it's YOUR tournament
                if (data.player.toLowerCase() !== currentAddress.toLowerCase()) {
                    showStatus('completeStatus', `
                        ‚ùå Not your tournament!<br>
                        <strong>Tournament Player:</strong> ${data.player}<br>
                        <strong>Your Address:</strong> ${currentAddress}
                    `, 'error');
                    return;
                }

                const confirmMsg = `
                    Force complete tournament?<br><br>
                    <strong>ID:</strong> ${tournamentId}<br>
                    <strong>Wins:</strong> ${wins}<br>
                    <strong>Perfect:</strong> ${isPerfect ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Estimated Reward:</strong> ${calculateRewardEstimate(data.difficulty, wins, isPerfect)} PKCN<br><br>
                    <span style="color:#ffaa00">‚ö†Ô∏è This bypasses the battle system and marks it complete on-chain.</span>
                `;

                if (!confirm(confirmMsg.replace(/<br>/g, '\n'))) return;

                showStatus('completeStatus', '‚è≥ Sending transaction...', 'info');
                console.log(`Force completing tournament: ${tournamentId}`);

                const tx = await tournamentContract.completeTournament(tournamentId, wins, isPerfect);
                showStatus('completeStatus', `‚è≥ TX: ${tx.hash}<br>Waiting for confirmation...`, 'info');

                const receipt = await tx.wait();
                if (receipt.status === 1) {
                    showStatus('completeStatus', `
                        ‚úÖ Tournament force completed!<br><br>
                        <strong>‚ú® You can now claim this reward in your Profile page!</strong><br>
                        <span style="color:#00ff9d">Go to Profile ‚Üí Unclaimed Rewards</span>
                    `, 'success');
                    
                    setTimeout(() => checkUnclaimedRewards(), 2000);
                } else {
                    showStatus('completeStatus', '‚ùå Transaction failed', 'error');
                }

            } catch (error) {
                let errorMsg = `‚ùå Failed: ${error.message}`;
                
                if (error.message.includes('Tournament not found')) {
                    errorMsg += '<br><br><span style="color:#ffaa00">üí° Tournament doesn\'t exist on-chain.</span>';
                } else if (error.message.includes('user rejected')) {
                    errorMsg += '<br><br><span style="color:#ffaa00">üí° You rejected the transaction in MetaMask.</span>';
                } else if (error.message.includes('Not tournament owner')) {
                    errorMsg += '<br><br><span style="color:#ff4444">üîí Not your tournament.</span>';
                }
                
                showStatus('completeStatus', errorMsg, 'error');
            }
        }

        // ==================== REWARD CALCULATOR ====================
        function calculateRewardEstimate(difficulty, wins, isPerfect) {
            const base = { "easy": 5, "normal": 15, "hard": 25, "insane": 35 }[difficulty] || 15;
            const winBonus = wins * (base / 2);
            const perfectBonus = isPerfect ? base * 2 : 0;
            const total = base + winBonus + perfectBonus;
            return Math.min(total, 250); // Max 250 PKCN
        }

        // ==================== CHECK UNCLAIMED REWARDS ====================
        async function checkUnclaimedRewards() {
            if (!await init()) return;

            try {
                const [ids, rewards] = await tournamentContract.getUnclaimedRewards(currentAddress);
                
                if (ids.length === 0) {
                    showStatus('claimStatus', '‚úÖ No unclaimed rewards', 'info');
                    return;
                }

                let html = `<strong>Found ${ids.length} unclaimed reward(s):</strong><br><br>`;
                let total = 0;
                
                ids.forEach((id, i) => {
                    const reward = rewards[i] ? rewards[i].toString() : '0';
                    total += parseInt(reward);
                    html += `‚Ä¢ ${id.substring(0, 30)}... ‚Üí ${reward} PKCN<br>`;
                });
                
                html += `<br><strong>Total: ${total} PKCN</strong><br><br>`;
                html += `<span style="color:#00ff9d">Go to Profile page to claim!</span>`;
                
                showStatus('claimStatus', html, 'success');
            } catch (error) {
                showStatus('claimStatus', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ==================== CHECK TOURNAMENT STATE ====================
        async function checkTournamentState() {
            if (!await init()) return;

            const tournamentId = document.getElementById('tournamentId').value.trim();
            if (!tournamentId) {
                showStatus('completeStatus', '‚ö†Ô∏è Enter tournament ID', 'error');
                return;
            }

            try {
                const data = await tournamentContract.tournaments(tournamentId);
                
                if (data.player === ethers.ZeroAddress && data.wins === 0n) {
                    showStatus('completeStatus', `
                        ‚ùå Tournament NOT FOUND on-chain<br>
                        <strong>ID:</strong> ${tournamentId}
                    `, 'error');
                    return;
                }

                const html = `
                    <strong>‚úÖ Tournament Found</strong><br><br>
                    <strong>Player:</strong> ${data.player}<br>
                    <strong>Difficulty:</strong> ${data.difficulty}<br>
                    <strong>Wins:</strong> ${data.wins.toString()}/${data.opponentCount.toString()}<br>
                    <strong>Complete:</strong> ${data.isComplete ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Claimed:</strong> ${data.rewardClaimed ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Your Address:</strong> ${currentAddress}<br>
                    <strong>Is Yours:</strong> ${data.player.toLowerCase() === currentAddress.toLowerCase() ? '‚úÖ Yes' : '‚ùå No'}
                `;
                
                showStatus('completeStatus', html, data.isComplete ? 'success' : 'info');
            } catch (error) {
                showStatus('completeStatus', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ==================== CLEAR LOCALSTORAGE ====================
        function clearLocalStorage() {
            if (!confirm('üö® Clear ALL tournament localStorage?\nThis will remove currentTournamentId, currentTournament, and tournamentHistory.\n\nProceed?')) return;

            localStorage.removeItem('currentTournamentId');
            localStorage.removeItem('currentTournament');
            localStorage.removeItem('tournamentHistory');
            
            showStatus('emergencyStatus', '‚úÖ LocalStorage cleared!<br><br>Refresh the page to start fresh.', 'success');
            console.log('LocalStorage cleared');
        }

        // ==================== PAGE LOAD ====================
        window.addEventListener('load', () => {
            loadConfig();
            
            // Auto-populate tournament ID if available
            const urlParams = new URLSearchParams(window.location.search);
            const tourId = urlParams.get('tournamentId') || localStorage.getItem('currentTournamentId');
            if (tourId) {
                document.getElementById('tournamentId').value = tourId;
            }

            // Auto-init if wallet is already connected
            if (window.ethereum) {
                window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                    if (accounts.length > 0) {
                        init();
                    }
                });
            }
        });
    </script>
</body>
</html>